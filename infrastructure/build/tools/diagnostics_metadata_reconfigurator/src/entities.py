##############################################################################
# (c) Crown copyright 2020 Met Office. All rights reserved.
# The file LICENCE, distributed with this code, contains details of the terms
# under which the code may be used.
##############################################################################
"""Entities to store data collected by MetadataExtractor"""
from typing import Dict, Set


# Tell pylint to allow large constructors on entities, allow too few public
# methods as public attributes can accessed directly, allow many
# instance attributes

# pylint: disable=too-few-public-methods, too-many-instance-attributes


class Field:
    """Stores attributes of a metadata field"""

    def __init__(self, unique_id: str, active: bool = False,
                 checksum: bool = False, long_name: str = None,
                 standard_name: str = None, units: str = None,
                 grid_ref: str = None, mesh_id: int = None,
                 function_space: str = None, order: int = None,
                 io_driver: str = None, data_type: str = None,
                 timestep: str = None):
        """

        :param unique_id: Identifier for metadata field
        :param active: Whether or not the field is activated in the Rose suite
        :param checksum: Flag to control if a checksum of the final field state
                         is generated
        :param long_name: Descriptive name, particularly when there
                          is no standard name
        :param standard_name: Descriptive name as defined by the
                               CF/CMIP/etc convention
        :param units: Unit of measurement
        :param grid_ref: Which XIOS grid the field is being output on
                         (work in progress)
        :param mesh_id: Which LFRic grid the field is being held against
        :param function_space: The function space within which the field exists
        :param order: Finite element order
        :param io_driver: Which driver LFRic uses to convert the field to
                          the correct structure to transmit to XIOS
        :param data_type: INT/REAL
        :param timestep: If field is restricted, timestep value will be present
                         to specify on which timesteps the field is calculated
        """
        # pylint: disable=too-many-arguments
        self.unique_id = unique_id
        self.active = active
        self.checksum = checksum
        self.long_name = long_name
        self.standard_name = standard_name
        self.units = units
        self.grid_ref = grid_ref
        self.function_space = function_space
        self.mesh_id = mesh_id
        self.order = order
        self.io_driver = io_driver
        self.data_type = data_type
        # this will be used for timestep restricted fields
        self.timestep = timestep


class FieldGroup:
    """Stores a field group and its fields"""

    def __init__(self, name: str, timestep: str = "1ts",
                 temporal: str = "instant"):
        """
        :param name: Identifier for the field group
        :param timestep: Default timestep on which fields in the group
                         will be generated by LFRic
        :param temporal: Which statistical operation is applied to fields in
                         the group (always instant)
        """
        self.name = name
        self.timestep = timestep
        self.temporal = temporal
        # Initialised collection to be an empty set of [Field.unique_id]s
        self._fields: Set = set()

    def add_field(self, field: Field):
        """Add a field to the field group"""
        self._fields.add(field.unique_id)

    def get_fields(self):
        """:return: Sorted list of fields contained within the group"""
        return sorted(self._fields)


class OutputStreamField:
    """Stores attributes of an output stream field"""

    def __init__(self, unique_id: int, field_ref: str = "",
                 temporal: str = "instant"):
        """
        :param unique_id: Identifier for the output stream field within the
                          output stream
        :param field_ref: Field.unique_id of the field to output
        :param temporal: Which statistical operation is applied to the field
        """
        self.unique_id = unique_id
        self.field_ref = field_ref
        self.temporal = temporal


class OutputStream:
    """Stores attributes of an output stream and its output fields"""

    def __init__(self, unique_id: int, name: str = None, timestep: str = None):
        """
        :param unique_id: Identifier for the output stream
        :param name: Name of the output file
        :param timestep: Timestep frequency on which the file is output
                         (and any statistics are applied over)
        """
        self.unique_id: int = unique_id
        self.name: str = name
        self.timestep: str = timestep
        # Initialised collection to be empty set
        # of [OutputStreamField.unique_id: OutputStreamField]
        self._stream_fields: Dict[int, OutputStreamField] = {}
        # XIOS file convention
        # always UGRID, even if the file conforms to additional standards
        self.convention: str = 'UGRID'

    def add_field(self, field: OutputStreamField):
        """Adds an output field to the output stream's field collection"""
        self._stream_fields.update({field.unique_id: field})

    def get_fields(self) -> [OutputStreamField]:
        """
        :return: Sorted list of output stream fields
        """
        return sorted(self._stream_fields.values(),
                      key=lambda field: field.unique_id)
