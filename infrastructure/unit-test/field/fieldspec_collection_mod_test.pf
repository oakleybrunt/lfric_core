!-----------------------------------------------------------------------------
! (C) Crown copyright 2020 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

!> Test the fieldspec collection object
!>
module fieldspec_collection_mod_test

  use constants_mod,              only: i_def
  use fieldspec_mod,              only: fieldspec_type
  use fieldspec_collection_mod,   only: fieldspec_collection_type
  use fs_continuity_mod,          only: W3
  use io_driver_enum_mod,         only: WRITE_FIELD_FACE
  use pFUnit_Mod

  implicit none

  private
  public :: test_assignment

  @TestCase
  type, extends(TestCase), public :: fieldspec_collection_test_type
    private
  contains
    procedure setUp
    procedure tearDown
    procedure test_assignment
  end type fieldspec_collection_test_type

contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine setUp( this )

    implicit none

    class(fieldspec_collection_test_type), intent(inout) :: this

  end subroutine setUp

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  subroutine tearDown( this )

    implicit none

    class(fieldspec_collection_test_type), intent(inout) :: this

  end subroutine tearDown

  !> Test that fieldspec objects are correctly added to the collection and are retrievable
  !>
  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @test
  subroutine test_assignment( self )

    implicit none

    class(fieldspec_collection_test_type), intent(inout) :: self
    type(fieldspec_type)                                 :: test_fieldspec1
    type(fieldspec_type),                  pointer       :: returned_fieldspec => null()
    type(fieldspec_collection_type)                      :: f_collection

    f_collection = fieldspec_collection_type()

    call f_collection%generate_and_add_fieldspec( "foo", "field_group_id", &
                                       1_i_def, W3, 0_i_def, &
                                       0_i_def, 0_i_def, WRITE_FIELD_FACE )
    call f_collection%generate_and_add_fieldspec("bar", "field_group_id", &
                                       1_i_def, W3, 0_i_def, &
                                       0_i_def, 0_i_def, WRITE_FIELD_FACE)

    returned_fieldspec => f_collection%get_fieldspec("absent")
    @assertNotAssociated(returned_fieldspec)
    returned_fieldspec => f_collection%get_fieldspec("foo")
    @assertAssociated(returned_fieldspec)
    @assertEqual("foo", returned_fieldspec%get_unique_id())
    returned_fieldspec => f_collection%get_fieldspec("bar")
    @assertEqual("bar", returned_fieldspec%get_unique_id())

  end subroutine test_assignment

end module fieldspec_collection_mod_test
