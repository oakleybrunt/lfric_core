!-----------------------------------------------------------------------------
! (c) Crown copyright 2023 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

!>@brief Drives the execution of the da dev algorithms tests
module test_algorithm_mod

  use constants_mod,                 only : i_def, r_def
  use driver_fem_mod,                only : init_fem, final_fem
  use field_mod,                     only : field_type, field_proxy_type
  use fs_continuity_mod,             only : Wtheta
  use function_space_collection_mod, only : function_space_collection
  use function_space_mod,            only : function_space_type
  use log_mod,                       only : log_event, &
                                            LOG_LEVEL_INFO
  use mesh_mod,                      only : mesh_type

  implicit none

  private
  public test_algorithm_initialise, &
         test_algorithm_finalise,   &
         test_da_dev_increment_alg

  character(len=128)                     :: output

  ! Coordinate field
  type(field_type), target, dimension(3) :: chi
  type(field_type), target               :: panel_id
  type(function_space_type), pointer     :: wtheta_fs => null()
  integer(i_def),   parameter            :: element_order = 0

contains

  !> @brief     Initialise module.
  !> @details   Initialises the fem & function space wtheta_fs
  !> @param[in] mesh Mesh to be used
  subroutine test_algorithm_initialise( mesh )

    implicit none

    type(mesh_type), pointer :: mesh

    call init_fem( mesh, chi, panel_id )
    wtheta_fs => function_space_collection%get_fs( mesh,          &
                                                   element_order, &
                                                   Wtheta )

  end subroutine test_algorithm_initialise

  !> @brief Finalises the fem & function space
  subroutine test_algorithm_finalise()

    implicit none

    call final_fem()
    nullify(wtheta_fs)

  end subroutine test_algorithm_finalise

  !> @brief     Tests da_dev_increment_alg
  !> @param[in] tolerance Tolerance
  subroutine test_da_dev_increment_alg( tolerance )

    use da_dev_increment_alg_mod, only : da_dev_increment_alg

    implicit none

    real(r_def), intent(in) :: tolerance

    type(field_type), target :: test_field
    type(field_proxy_type)   :: field_proxy

    ! Initialise test field and get proxy
    call test_field%initialise( wtheta_fs, name='test_field' )
    field_proxy = test_field%get_proxy()
    ! Set first dof to nominal value
    call invoke( setval_c(test_field, 1.0_r_def) )

    call da_dev_increment_alg(test_field)

    write ( output, '("Returned Field Values =", ES15.8)' ) field_proxy%data(1)

    ! Test if value is correct
    if ( all( abs(field_proxy%data(:) - 2.0_r_def)  <= tolerance ) ) then
      call log_event( 'test PASS', LOG_LEVEL_INFO )
      call log_event( output, LOG_LEVEL_INFO )
    else
      call log_event( 'test FAIL', LOG_LEVEL_INFO )
      call log_event( 'Expected Field Values = 2.00000000E+00', LOG_LEVEL_INFO )
      call log_event( output, LOG_LEVEL_INFO )
    end if

  end subroutine test_da_dev_increment_alg

end module test_algorithm_mod