!-----------------------------------------------------------------------------
! (C) Crown copyright 2023 Met Office. All rights reserved.
! The file LICENCE, distributed with this code, contains details of the terms
! under which the code may be used.
!-----------------------------------------------------------------------------

module consistent_hori_ox_deppt_kernel_mod_test

  use pFUnit_Mod
  use constants_mod,      only : i_def, r_tran, l_def

  implicit none

  private
  public :: consistent_hori_ox_deppt_test_type , test_all

  @TestCase
  type, extends(TestCase) :: consistent_hori_ox_deppt_test_type
    private
  contains
    procedure test_all
  end type consistent_hori_ox_deppt_test_type


contains

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  @Test
  subroutine test_all( this )

    use consistent_hori_ox_deppt_kernel_mod, only : consistent_hori_ox_deppt_code

    implicit none

    class(consistent_hori_ox_deppt_test_type), intent(inout) :: this

    real(kind=r_tran),   parameter   :: tol = 1.0e-6_r_tran
    real(kind=r_tran),   parameter   :: area = 4000.0_r_tran

    integer(kind=i_def)              :: nlayers, ncells, cell
    integer(kind=i_def)              :: stencil_extent, max_stencil_size
    integer(kind=i_def)              :: ndf_w2h, ndf_w3, k
    integer(kind=i_def)              :: undf_w2h, undf_w3, undf_w2x
    logical(kind=l_def)              :: cap_dep_points
    integer(kind=i_def), allocatable :: map_w2h(:,:)
    integer(kind=i_def), allocatable :: map_w3(:,:)
    integer(kind=i_def), allocatable :: stencil_size(:)
    integer(kind=i_def), allocatable :: stencil_map(:,:,:)
    integer(kind=i_def), allocatable :: i_start(:)
    integer(kind=i_def), allocatable :: i_end(:)
    real(kind=r_tran),   allocatable :: rho_d(:)
    real(kind=r_tran),   allocatable :: dry_flux(:)
    real(kind=r_tran),   allocatable :: x_w2x(:)
    real(kind=r_tran),   allocatable :: detj_at_w3(:)
    real(kind=r_tran),   allocatable :: dep_pts_x(:)
    real(kind=r_tran),   allocatable :: frac_dry_flux(:)
    real(kind=r_tran),   allocatable :: true_dep_pts_answer(:)
    real(kind=r_tran),   allocatable :: true_frac_flux_answer(:)

    ! Set integer values to describe mesh (single layer)
    nlayers = 1
    stencil_extent = 3
    ncells = 15
    undf_w2h = (ncells + 1) + 2*ncells
    ndf_w2h = 4
    undf_w3 = ncells
    ndf_w3 = 1
    undf_w2x = ncells + 1
    max_stencil_size = 2*stencil_extent + 1
    cap_dep_points = .false.

    allocate(map_w2h(ndf_w2h,ncells))
    allocate(map_w3(ndf_w3,ncells))
    allocate(stencil_size(ncells))
    allocate(stencil_map(ndf_w3,max_stencil_size,ncells))
    allocate(rho_d(undf_w3))
    allocate(dry_flux(undf_w2h))
    allocate(x_w2x(undf_w2x))
    allocate(detj_at_w3(undf_w3))
    allocate(dep_pts_x(undf_w2h))
    allocate(frac_dry_flux(undf_w2h))
    allocate(true_dep_pts_answer(undf_w2h))
    allocate(true_frac_flux_answer(undf_w2h))
    allocate(i_start(undf_w3))
    allocate(i_end(undf_w3))

    ! DoF maps
    map_w3 = reshape((/ 1, 2, 3, 4, 5, 6, 7, 8, &
                        9, 10, 11, 12, 13, 14, 15 /), [ndf_w3, ncells])
    map_w2h = reshape((/  1,  2,  3,  4,  3,  5,  6,  7,  6,  8,  9, 10,       &
                          9, 11, 12, 13, 12, 14, 15, 16, 15, 17, 18, 19,       &
                         18, 20, 21, 22, 21, 23, 24, 25, 24, 26, 27, 28,       &
                         27, 29, 30, 31, 30, 32, 33, 34, 33, 35, 36, 37,       &
                         36, 38, 39, 40, 39, 41, 42, 43, 42, 44, 45, 46 /), [ndf_w2h, ncells])
    stencil_size = (/ 4, 5, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7, 6, 5, 4 /)
    stencil_map = reshape( (/ (/ 1, 2, 3, 4, 0, 0, 0 /),          &
                              (/ 2, 1, 3, 4, 5, 0, 0 /),          &
                              (/ 3, 2, 1, 4, 5, 6, 0 /),          &
                              (/ 4, 3, 2, 1, 5, 6, 7 /),          &
                              (/ 5, 4, 3, 2, 6, 7, 8 /),          &
                              (/ 6, 5, 4, 3, 7, 8, 9 /),          &
                              (/ 7, 6, 5, 4, 8, 9, 10 /),         &
                              (/ 8, 7, 6, 5, 9, 10, 11 /),        &
                              (/ 9, 8, 7, 6, 10, 11, 12 /),       &
                              (/ 10, 9, 8, 7, 11, 12, 13 /),      &
                              (/ 11, 10, 9, 8, 12, 13, 14 /),     &
                              (/ 12, 11, 10, 9, 13, 14, 15 /),    &
                              (/ 13, 12, 11, 10, 14, 15, 0 /),    &
                              (/ 14, 13, 12, 11, 15, 0, 0 /),     &
                              (/ 15, 14, 13, 12, 0, 0, 0 /) /), [ndf_w3, 7, ncells])

    ! Set up non-uniform grid
    x_w2x = (/ -3.0_r_tran, -2.0_r_tran, -1.0_r_tran,                      &
               0.0_r_tran, 50.0_r_tran, 160.0_r_tran, 320.0_r_tran,        &
               600.0_r_tran, 1000.0_r_tran, 1500.0_r_tran, 2000.0_r_tran,  &
               2750.0_r_tran, 3000.0_r_tran,                               &
               3001.0_r_tran, 3003.0_r_tran, 3005.0_r_tran /)
    rho_d = (/ 2.5_r_tran, 2.5_r_tran, 2.5_r_tran,                         &
               2.0_r_tran, 1.5_r_tran, 1.1_r_tran, 1.2_r_tran, 1.0_r_tran, &
               0.8_r_tran, 0.8_r_tran, 0.5_r_tran, 0.2_r_tran,             &
               0.19_r_tran, 0.19_r_Tran, 0.19_r_Tran /)
    ! Computed by considering the mass flow to match the departure points
    dry_flux = (/ 0.0_r_tran, 0.0_r_tran, 0.0_r_tran, 0.0_r_tran,          &
                  0.0_r_tran, 0.0_r_tran, 0.0_r_tran,                      &
                  0.0_r_tran, 0.0_r_tran, 0.0_r_tran,                      &
                  0.0_r_tran, 320000.0_r_tran, 0.0_r_tran,                 &
                  0.0_r_tran, 740000.0_r_tran, 0.0_r_tran,                 &
                  0.0_r_tran, 281600.0_r_tran, 0.0_r_tran,                 &
                  0.0_r_tran, -800000.0_r_tran, 0.0_r_tran,                &
                  0.0_r_tran, -1920000.0_r_tran, 0.0_r_tran,               &
                  0.0_r_tran, -3120000.0_r_tran, 0.0_r_tran,               &
                  0.0_r_tran, -1600000.0_r_tran, 0.0_r_tran,               &
                  0.0_r_tran, -120000.0_r_tran, 0.0_r_tran,                &
                  0.0_r_tran, 0.0_r_tran, 0.0_r_tran,                      &
                  0.0_r_tran, 0.0_r_tran, 0.0_r_tran,                      &
                  0.0_r_tran, 0.0_r_tran, 0.0_r_tran,                      &
                  0.0_r_tran, 0.0_r_tran, 0.0_r_tran /)

    ! Calculate this as area*height_difference
    do k = 1, undf_w3
      detj_at_w3(k) = area*(x_w2x(k+1) - x_w2x(k))
    end do

    i_start(:) = -1_i_def
    i_end(:) = -2_i_def

    true_dep_pts_answer = (/ 0.0_r_tran, 0.0_r_tran, 0.0_r_tran, 0.0_r_tran,   &
                             0.0_r_tran, 0.0_r_tran, 0.0_r_tran,               &
                             0.0_r_tran, 0.0_r_tran, 0.0_r_tran,               &
                             0.0_r_tran, 0.8_r_tran, 0.0_r_tran,               &
                             0.0_r_tran, 1.2_r_tran, 0.0_r_tran,               &
                             0.0_r_tran, 0.4_r_tran, 0.0_r_tran,               &
                             0.0_r_tran, -0.5_r_tran, 0.0_r_tran,              &
                             0.0_r_tran, -1.2_r_tran, 0.0_r_tran,              &
                             0.0_r_tran, -2.1_r_tran, 0.0_r_tran,              &
                             0.0_r_tran, -1.5_r_tran, 0.0_r_tran,              &
                             0.0_r_tran, -0.6_r_tran, 0.0_r_tran,              &
                             0.0_r_tran, 0.0_r_tran, 0.0_r_tran,               &
                             0.0_r_tran, 0.0_r_tran, 0.0_r_tran,               &
                             0.0_r_tran, 0.0_r_tran, 0.0_r_tran,               &
                             0.0_r_tran, 0.0_r_tran, 0.0_r_tran /)
    true_frac_flux_answer = (/ 0.0_r_tran, 0.0_r_tran, 0.0_r_tran, 0.0_r_tran, &
                               0.0_r_tran, 0.0_r_tran, 0.0_r_tran,             &
                               0.0_r_tran, 0.0_r_tran, 0.0_r_tran,             &
                               0.0_r_tran, 320000.0_r_tran, 0.0_r_tran,        &
                               0.0_r_tran, 80000.0_r_tran, 0.0_r_tran,         &
                               0.0_r_tran, 281600.0_r_tran, 0.0_r_tran,        &
                               0.0_r_tran, -800000.0_r_tran, 0.0_r_tran,       &
                               0.0_r_tran, -320000.0_r_tran, 0.0_r_tran,       &
                               0.0_r_tran, -20000.0_r_tran, 0.0_r_tran,        &
                               0.0_r_tran, -100000.0_r_tran, 0.0_r_tran,       &
                               0.0_r_tran, -120000.0_r_tran, 0.0_r_tran,       &
                               0.0_r_tran, 0.0_r_tran, 0.0_r_tran,             &
                               0.0_r_tran, 0.0_r_tran, 0.0_r_tran,             &
                               0.0_r_tran, 0.0_r_tran, 0.0_r_tran,             &
                               0.0_r_tran, 0.0_r_tran, 0.0_r_tran /)


    ! Set initial values of output fields to be zero
    dep_pts_x(:) = 0.0_r_tran
    frac_dry_flux(:) = 0.0_r_tran

    do cell = 1, ncells
      call consistent_hori_ox_deppt_code(                   &
                  nlayers,                                  &
                  dep_pts_x,                                &
                  frac_dry_flux,                            &
                  dry_flux,                                 &
                  rho_d,                                    &
                  stencil_size(cell),                       &
                  stencil_map(:,:,cell),                    &
                  rho_d,                                    &
                  stencil_size(cell),                       &
                  stencil_map(:,:,cell),                    &
                  detj_at_w3,                               &
                  stencil_size(cell),                       &
                  stencil_map(:,1:stencil_size(cell),cell), &
                  i_start,                                  &
                  i_end,                                    &
                  stencil_extent,                           &
                  cap_dep_points,                           &
                  ndf_w2h,                                  &
                  undf_w2h,                                 &
                  map_w2h(:,cell),                          &
                  ndf_w3,                                   &
                  undf_w3,                                  &
                  map_w3(:,cell),                           &
                  ndf_w3,                                   &
                  undf_w3,                                  &
                  map_w3(:,cell) )
    end do

    @assertEqual( dep_pts_x, true_dep_pts_answer, tol )
    @assertEqual( frac_dry_flux, true_frac_flux_answer, tol )

    deallocate(map_w2h)
    deallocate(map_w3)
    deallocate(stencil_map)
    deallocate(stencil_size)
    deallocate(frac_dry_flux)
    deallocate(dep_pts_x)
    deallocate(x_w2x)
    deallocate(detj_at_w3)
    deallocate(dry_flux)
    deallocate(rho_d)
    deallocate(true_dep_pts_answer)
    deallocate(true_frac_flux_answer)
    deallocate(i_start)
    deallocate(i_end)

  end subroutine test_all

end module consistent_hori_ox_deppt_kernel_mod_test
