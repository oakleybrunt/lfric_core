!-----------------------------------------------------------------------------
! (c) The copyright relating to this work is owned jointly by the Crown, 
! Met Office and NERC 2014. 
! However, it has been created with the help of the GungHo Consortium, 
! whose members are identified at https://puma.nerc.ac.uk/trac/GungHo/wiki
!-----------------------------------------------------------------------------

!> Test the stencil_dofmap representation
!>
module stencil_dofmap_mod_test

  implicit none 


contains

  @test
  subroutine test_stencil_dofmap()

    use pFUnit_Mod
    use stencil_dofmap_mod,  only: stencil_dofmap_type, STENCIL_POINT
    use master_dofmap_mod,   only: master_dofmap_type
    use mesh_mod,            only: mesh_type, PLANE_BI_PERIODIC

    implicit none

    type(stencil_dofmap_type)            :: dofmap
    type(master_dofmap_type)             :: master_dofmap
    integer, allocatable, dimension(:,:) :: master_map_init, master_map_copy
    type(mesh_type)                      :: mesh
    integer, pointer                     :: map(:,:) => null()
    integer                              :: ncells, ndf, cell, df, id
    integer :: err

    ! Dummy mesh mod has 9 cells, 3 layers and is uniform in vertical
    mesh = mesh_type(PLANE_BI_PERIODIC)    

    ! Allocate the maps
    ncells = 4
    ndf = 3
    allocate( master_map_init(ndf,0:ncells), master_map_copy(ndf,0:ncells) )

    ! Populate the map
    master_map_init(:,1) = (/ 0, 0, 0 /)
    master_map_init(:,1) = (/ 1, 2, 3 /)
    master_map_init(:,2) = (/ 3, 4, 5 /)
    master_map_init(:,3) = (/ 5, 6, 7 /)
    master_map_init(:,4) = (/ 8, 9, 10/)

    master_map_copy = master_map_init
    master_dofmap = master_dofmap_type(master_map_init)

    dofmap = stencil_dofmap_type(STENCIL_POINT,1,ndf,mesh,master_dofmap)

    do cell = 1,ncells
      map => dofmap%get_dofmap(cell)
      do df = 1,ndf
        @assertEqual( map(df,1), master_map_copy(df,cell) )
      end do
    end do
    id = STENCIL_POINT*100 + 1
    @assertEqual( id, dofmap%get_id() )


    return
  end subroutine test_stencil_dofmap

end module stencil_dofmap_mod_test
