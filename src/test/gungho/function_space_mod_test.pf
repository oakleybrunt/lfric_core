!-------------------------------------------------------------------------------
! (c) The copyright relating to this work is owned jointly by the Crown, 
! Met Office and NERC 2014. 
! However, it has been created with the help of the GungHo Consortium, 
! whose members are identified at https://puma.nerc.ac.uk/trac/GungHo/wiki
!-------------------------------------------------------------------------------
!
!-------------------------------------------------------------------------------
module function_space_mod_test
  implicit none 

contains

  @test
  subroutine test_func_space()

    use pFUnit_Mod

    use constants_mod,         only: i_def, r_def
    use quadrature_mod,        only: quadrature_type, GAUSSIAN
    use stencil_dofmap_mod,    only: stencil_dofmap_type, STENCIL_POINT        &
                                   , STENCIL_CROSS, STENCIL_1DX                &
                                   , STENCIL_1DY

    use configuration_mod,     only: QUAD
    use mesh_mod,              only: mesh_type, PLANE_BI_PERIODIC
    use function_space_mod,    only: function_space_type                       &
                                   , purge_function_spaces
    use fs_continuity_mod,     only: W0, W1, W2, W3, Wtheta, W2V, W2H
    use reference_element_mod, only: reference_cube, deallocate_reference      &
                                   , reference_element

    use fs_test_data_mod  ! Will use everything in here
                          ! as it's the static data

    implicit none

    type(mesh_type),  pointer :: mesh_out => null()

    type(mesh_type)           :: mesh
    type(quadrature_type)     :: qr
    type(function_space_type) :: fs
    type(function_space_type), pointer :: test_fs0k0 => null()
    type(function_space_type), pointer :: test_fs1k0 => null()
    type(function_space_type), pointer :: test_fs2k0 => null()
    type(function_space_type), pointer :: test_fs3k0 => null()
    type(function_space_type), pointer :: test_fs4k0 => null()
    type(function_space_type), pointer :: test_fs5k0 => null()
    type(function_space_type), pointer :: test_fs6k0 => null()

    integer          :: scalar, vector
    integer          :: nqp_h, nqp_v

    real(r_def), pointer :: xp(:,:) => null()
    real(r_def), pointer :: zp(:)   => null()
    real(r_def)          :: epsilon

    integer          :: test_fs
    integer, pointer :: map(:) => null()
  

    real(r_def), allocatable, dimension(:,:,:,:) :: test_diff_basis
    real(r_def), allocatable, dimension(:,:,:,:) :: test_basis


    integer(i_def) :: err
    integer :: i
    integer :: cell
    integer :: ndf
    integer :: iface, iedge, lid, test_integer
    integer :: test_ncells
    integer :: test_ndof_cell
    integer :: test_dim_space
    integer :: test_dim_space_diff
    integer :: element_order

    type(stencil_dofmap_type), pointer :: stencil_dofmap   => null()
    integer,                   pointer :: stencil_map(:,:) => null()

    !--------------------------------------------------------------------------
    ! Colouring vars
    integer                 :: total_colours, colour_idx
    integer                 :: nc_colour, cic_colour
  
    integer(i_def)          :: num_colours
    integer(i_def), pointer :: num_cell_per_colour(:)
    integer(i_def), pointer :: cells_in_colour(:,:)
    !--------------------------------------------------------------------------






    reference_element = QUAD
    call reference_cube()

    scalar=1
    vector=3

    epsilon = 1.0e-14_r_def

    nqp_h = 9
    nqp_v = 3
    qr = quadrature_type(3, GAUSSIAN)
    xp => qr%get_xqp_h()
    zp => qr%get_xqp_v()

    ! Dummy mesh mod has 9 cells, 3 layers and is uniform in vertical
    mesh = mesh_type(PLANE_BI_PERIODIC)

    ! Set element order
    element_order = 0

    ! Make the function spaces
    test_fs0k0 => fs%get_instance(mesh, element_order, W0)
    test_fs1k0 => fs%get_instance(mesh, element_order, W1)
    test_fs2k0 => fs%get_instance(mesh, element_order, W2)
    test_fs3k0 => fs%get_instance(mesh, element_order, W3)
    test_fs4k0 => fs%get_instance(mesh, element_order, WTHETA)
    test_fs5k0 => fs%get_instance(mesh, element_order, W2V)
    test_fs6k0 => fs%get_instance(mesh, element_order, W2H)


    ! -----------------------------------
    ! Test w0, order-0
    ! -----------------------------------
    @assertEqual( fs0k0_dynamo_fs,     test_fs0k0%which()             )
    @assertEqual( fs0k0_element_order, test_fs0k0%get_element_order() )

    test_ncells    = test_fs0k0%get_ncell()
    test_ndof_cell = test_fs0k0%get_ndf()

    @assertEqual( fs0k0_ndof_cell,    test_ndof_cell           )
    @assertEqual( 9,                  test_ncells              )
    @assertEqual( 3,                  test_fs0k0%get_nlayers() )
    @assertEqual( fs0k0_ndof_glob,    test_fs0k0%get_undf()    )
    @assertEqual( fs0k0_ndof_cell,    test_fs0k0%get_ndf()     ) 
    @assertEqual( fs0k0_nodal_coords, test_fs0k0%get_nodes()   )

    test_dim_space      = test_fs0k0%get_dim_space()
    test_dim_space_diff = test_fs0k0%get_dim_space_diff()
    @assertEqual( fs0k0_dim_space,      test_dim_space         )  
    @assertEqual( fs0k0_dim_space_diff, test_dim_space_diff    ) 
   

    do cell=1, test_ncells
      @assertEqual( fs0k0_dofmap(:,cell),      test_fs0k0%get_cell_dofmap(cell)      )
    end do


    allocate( test_basis ( test_dim_space, test_ndof_cell, nqp_h, nqp_v) )
    call test_fs0k0%compute_basis_function                                     &
       ( test_basis, test_ndof_cell, nqp_h, nqp_v, xp, zp )
    @assertEqual(fs0k0_basis_function, test_basis, epsilon)
    deallocate(test_basis)


    allocate( test_diff_basis( test_dim_space_diff, test_ndof_cell             &
                             , nqp_h, nqp_v) )
    call test_fs0k0%compute_diff_basis_function                                &
       ( test_diff_basis, test_ndof_cell, nqp_h, nqp_v, xp, zp )
    @assertEqual(fs0k0_basis_diff_function, test_diff_basis, epsilon)
    deallocate(test_diff_basis)





    ! -----------------------------------
    ! Test w1, order-0
    ! -----------------------------------
    @assertEqual( fs1k0_dynamo_fs,     test_fs1k0%which()             )
    @assertEqual( fs1k0_element_order, test_fs1k0%get_element_order() )

    test_ncells    = test_fs1k0%get_ncell()
    test_ndof_cell = test_fs1k0%get_ndf()

    @assertEqual( fs1k0_ndof_cell,    test_ndof_cell           )
    @assertEqual( 9,                  test_ncells              )
    @assertEqual( 3,                  test_fs1k0%get_nlayers() )
    @assertEqual( fs1k0_ndof_glob,    test_fs1k0%get_undf()    )
    @assertEqual( fs1k0_ndof_cell,    test_fs1k0%get_ndf()     ) 
    @assertEqual( fs1k0_nodal_coords, test_fs1k0%get_nodes()   )

    test_dim_space      = test_fs1k0%get_dim_space()
    test_dim_space_diff = test_fs1k0%get_dim_space_diff()
    @assertEqual( fs1k0_dim_space,      test_dim_space         )  
    @assertEqual( fs1k0_dim_space_diff, test_dim_space_diff    ) 
   

    do cell=1, test_ncells
      @assertEqual( fs1k0_dofmap(:,cell),      test_fs1k0%get_cell_dofmap(cell)      )
    end do


    allocate( test_basis ( test_dim_space, test_ndof_cell, nqp_h, nqp_v) )
    call test_fs1k0%compute_basis_function                                     &
       ( test_basis, test_ndof_cell, nqp_h, nqp_v, xp, zp )
    @assertEqual(fs1k0_basis_function, test_basis, epsilon)
    deallocate(test_basis)


    allocate( test_diff_basis( test_dim_space_diff, test_ndof_cell             &
                             , nqp_h, nqp_v) )
    call test_fs1k0%compute_diff_basis_function                                &
       ( test_diff_basis, test_ndof_cell, nqp_h, nqp_v, xp, zp )
    @assertEqual(fs1k0_basis_diff_function, test_diff_basis, epsilon)
    deallocate(test_diff_basis)


    ! Test the stencil dofmap linked list structure
    stencil_dofmap => test_fs1k0%ll_get_instance(STENCIL_1DX,3)
    stencil_map    => stencil_dofmap%get_dofmap(1)

    map => test_fs1k0%get_cell_dofmap(1)
    @assertEqual( map, stencil_map(:,1) )
    map => test_fs1k0%get_cell_dofmap(mesh%get_cell_next(1,1))
    @assertEqual( map, stencil_map(:,2) )
    map => test_fs1k0%get_cell_dofmap(mesh%get_cell_next(3,1))
    @assertEqual( map, stencil_map(:,3) )

    stencil_dofmap => test_fs1k0%ll_get_instance(STENCIL_1DY,5)
    stencil_map => stencil_dofmap%get_dofmap(1)

    map => test_fs1k0%get_cell_dofmap(1)
    @assertEqual( map, stencil_map(:,1) )
    map => test_fs1k0%get_cell_dofmap(mesh%get_cell_next(2,1))
    @assertEqual( map, stencil_map(:,2) )
    map => test_fs1k0%get_cell_dofmap(mesh%get_cell_next(4,1))
    @assertEqual( map, stencil_map(:,3) )
    map => test_fs1k0%get_cell_dofmap(&
           mesh%get_cell_next(2,mesh%get_cell_next(2,1)))
    @assertEqual( map, stencil_map(:,4) )
    map => test_fs1k0%get_cell_dofmap(&
              mesh%get_cell_next(4,mesh%get_cell_next(4,1)))
    @assertEqual( map, stencil_map(:,5) )



    ! -----------------------------------
    ! Test w2, order-0
    ! -----------------------------------
    @assertEqual( fs2k0_dynamo_fs,     test_fs2k0%which()             )
    @assertEqual( fs2k0_element_order, test_fs2k0%get_element_order() )

    test_ncells    = test_fs2k0%get_ncell()
    test_ndof_cell = test_fs2k0%get_ndf()

    @assertEqual( fs2k0_ndof_cell,    test_ndof_cell           )
    @assertEqual( 9,                  test_ncells              )
    @assertEqual( 3,                  test_fs2k0%get_nlayers() )
    @assertEqual( fs2k0_ndof_glob,    test_fs2k0%get_undf()    )
    @assertEqual( fs2k0_ndof_cell,    test_fs2k0%get_ndf()     ) 
    @assertEqual( fs2k0_nodal_coords, test_fs2k0%get_nodes()   )

    test_dim_space      = test_fs2k0%get_dim_space()
    test_dim_space_diff = test_fs2k0%get_dim_space_diff()
    @assertEqual( fs2k0_dim_space,      test_dim_space         )  
    @assertEqual( fs2k0_dim_space_diff, test_dim_space_diff    ) 
   

    do cell=1, test_ncells
      @assertEqual( fs2k0_dofmap(:,cell),      test_fs2k0%get_cell_dofmap(cell)      )
    end do


    allocate( test_basis ( test_dim_space, test_ndof_cell, nqp_h, nqp_v) )
    call test_fs2k0%compute_basis_function                                     &
       ( test_basis, test_ndof_cell, nqp_h, nqp_v, xp, zp )
    @assertEqual(fs2k0_basis_function, test_basis, epsilon)
    deallocate(test_basis)


    allocate( test_diff_basis( test_dim_space_diff, test_ndof_cell             &
                             , nqp_h, nqp_v) )
    call test_fs2k0%compute_diff_basis_function                                &
       ( test_diff_basis, test_ndof_cell, nqp_h, nqp_v, xp, zp )
    @assertEqual(fs2k0_basis_diff_function, test_diff_basis, epsilon)
    deallocate(test_diff_basis)


    ! Test the stencil dofmap linked list structure
    stencil_dofmap => test_fs2k0%ll_get_instance(STENCIL_POINT,1)
    stencil_map => stencil_dofmap%get_dofmap(1)
    map => test_fs2k0%get_cell_dofmap(1)
    @assertEqual( map, stencil_map(:,1) )

    stencil_dofmap => test_fs2k0%ll_get_instance(STENCIL_CROSS,5)
    stencil_map => stencil_dofmap%get_dofmap(1)
    map => test_fs2k0%get_cell_dofmap(1)
    @assertEqual( map, stencil_map(:,1) )
    do i = 1,4
      map => test_fs2k0%get_cell_dofmap(mesh%get_cell_next(i,1))
      @assertEqual( map, stencil_map(:,i+1) )
    end do


    ! -----------------------------------
    ! Test w3, order-0
    ! -----------------------------------
    @assertEqual( fs3k0_dynamo_fs,     test_fs3k0%which()             )
    @assertEqual( fs3k0_element_order, test_fs3k0%get_element_order() )

    test_ncells    = test_fs3k0%get_ncell()
    test_ndof_cell = test_fs3k0%get_ndf()

    @assertEqual( fs3k0_ndof_cell,    test_ndof_cell           )
    @assertEqual( 9,                  test_ncells              )
    @assertEqual( 3,                  test_fs3k0%get_nlayers() )
    @assertEqual( fs3k0_ndof_glob,    test_fs3k0%get_undf()    )
    @assertEqual( fs3k0_ndof_cell,    test_fs3k0%get_ndf()     ) 
    @assertEqual( fs3k0_nodal_coords, test_fs3k0%get_nodes()   )

    test_dim_space      = test_fs3k0%get_dim_space()
    test_dim_space_diff = test_fs3k0%get_dim_space_diff()
    @assertEqual( fs3k0_dim_space,      test_dim_space         )  
    @assertEqual( fs3k0_dim_space_diff, test_dim_space_diff    ) 
   

    do cell=1, test_ncells
      @assertEqual( fs3k0_dofmap(:,cell),      test_fs3k0%get_cell_dofmap(cell)      )
    end do


    allocate( test_basis ( test_dim_space, test_ndof_cell, nqp_h, nqp_v) )
    call test_fs3k0%compute_basis_function                                     &
       ( test_basis, test_ndof_cell, nqp_h, nqp_v, xp, zp )
    @assertEqual(fs3k0_basis_function, test_basis, epsilon)
    deallocate(test_basis)


    allocate( test_diff_basis( test_dim_space_diff, test_ndof_cell             &
                             , nqp_h, nqp_v) )
    call test_fs3k0%compute_diff_basis_function                                &
       ( test_diff_basis, test_ndof_cell, nqp_h, nqp_v, xp, zp )
    @assertEqual(fs3k0_basis_diff_function, test_diff_basis, epsilon)
    deallocate(test_diff_basis)


    ! -----------------------------------
    ! Test wtheta, order-0
    ! -----------------------------------
    @assertEqual( fs4k0_dynamo_fs,     test_fs4k0%which()             )
    @assertEqual( fs4k0_element_order, test_fs4k0%get_element_order() )

    test_ncells    = test_fs4k0%get_ncell()
    test_ndof_cell = test_fs4k0%get_ndf()

    @assertEqual( fs4k0_ndof_cell,    test_ndof_cell           )
    @assertEqual( 9,                  test_ncells              )
    @assertEqual( 3,                  test_fs4k0%get_nlayers() )
    @assertEqual( fs4k0_ndof_glob,    test_fs4k0%get_undf()    )
    @assertEqual( fs4k0_ndof_cell,    test_fs4k0%get_ndf()     ) 
    @assertEqual( fs4k0_nodal_coords, test_fs4k0%get_nodes()   )

    test_dim_space      = test_fs4k0%get_dim_space()
    test_dim_space_diff = test_fs4k0%get_dim_space_diff()
    @assertEqual( fs4k0_dim_space,      test_dim_space         )  
    @assertEqual( fs4k0_dim_space_diff, test_dim_space_diff    ) 
   

    do cell=1, test_ncells
      @assertEqual( fs4k0_dofmap(:,cell),      test_fs4k0%get_cell_dofmap(cell)      )
    end do


    allocate( test_basis ( test_dim_space, test_ndof_cell, nqp_h, nqp_v) )
    call test_fs4k0%compute_basis_function                                     &
       ( test_basis, test_ndof_cell, nqp_h, nqp_v, xp, zp )
    @assertEqual(fs4k0_basis_function, test_basis, epsilon)
    deallocate(test_basis)


    allocate( test_diff_basis( test_dim_space_diff, test_ndof_cell             &
                             , nqp_h, nqp_v) )
    call test_fs4k0%compute_diff_basis_function                                &
       ( test_diff_basis, test_ndof_cell, nqp_h, nqp_v, xp, zp )
    @assertEqual(fs4k0_basis_diff_function, test_diff_basis, epsilon)
    deallocate(test_diff_basis)


    ! -----------------------------------
    ! Test w2v, order-0
    ! -----------------------------------
    @assertEqual( fs5k0_dynamo_fs,     test_fs5k0%which()             )
    @assertEqual( fs5k0_element_order, test_fs5k0%get_element_order() )

    test_ncells    = test_fs5k0%get_ncell()
    test_ndof_cell = test_fs5k0%get_ndf()

    @assertEqual( fs5k0_ndof_cell,    test_ndof_cell           )
    @assertEqual( 9,                  test_ncells              )
    @assertEqual( 3,                  test_fs5k0%get_nlayers() )
    @assertEqual( fs5k0_ndof_glob,    test_fs5k0%get_undf()    )
    @assertEqual( fs5k0_ndof_cell,    test_fs5k0%get_ndf()     ) 
    @assertEqual( fs5k0_nodal_coords, test_fs5k0%get_nodes()   )

    test_dim_space      = test_fs5k0%get_dim_space()
    test_dim_space_diff = test_fs5k0%get_dim_space_diff()
    @assertEqual( fs5k0_dim_space,      test_dim_space         )  
    @assertEqual( fs5k0_dim_space_diff, test_dim_space_diff    ) 
   

    do cell=1, test_ncells
      @assertEqual( fs5k0_dofmap(:,cell),      test_fs5k0%get_cell_dofmap(cell)      )
    end do


    allocate( test_basis ( test_dim_space, test_ndof_cell, nqp_h, nqp_v) )
    call test_fs5k0%compute_basis_function                                     &
       ( test_basis, test_ndof_cell, nqp_h, nqp_v, xp, zp )
    @assertEqual(fs5k0_basis_function, test_basis, epsilon)
    deallocate(test_basis)


    allocate( test_diff_basis( test_dim_space_diff, test_ndof_cell             &
                             , nqp_h, nqp_v) )
    call test_fs5k0%compute_diff_basis_function                                &
       ( test_diff_basis, test_ndof_cell, nqp_h, nqp_v, xp, zp )
    @assertEqual(fs5k0_basis_diff_function, test_diff_basis, epsilon)
    deallocate(test_diff_basis)


    ! -----------------------------------
    ! Test w2h, order-0
    ! -----------------------------------
    @assertEqual( fs6k0_dynamo_fs,     test_fs6k0%which()             )
    @assertEqual( fs6k0_element_order, test_fs6k0%get_element_order() )

    test_ncells    = test_fs6k0%get_ncell()
    test_ndof_cell = test_fs6k0%get_ndf()

    @assertEqual( fs6k0_ndof_cell,    test_ndof_cell           )
    @assertEqual( 9,                  test_ncells              )
    @assertEqual( 3,                  test_fs6k0%get_nlayers() )
    @assertEqual( fs6k0_ndof_glob,    test_fs6k0%get_undf()    )
    @assertEqual( fs6k0_ndof_cell,    test_fs6k0%get_ndf()     ) 
    @assertEqual( fs6k0_nodal_coords, test_fs6k0%get_nodes()   )

    test_dim_space      = test_fs6k0%get_dim_space()
    test_dim_space_diff = test_fs6k0%get_dim_space_diff()
    @assertEqual( fs6k0_dim_space,      test_dim_space         )  
    @assertEqual( fs6k0_dim_space_diff, test_dim_space_diff    ) 
   

    do cell=1, test_ncells
      @assertEqual( fs6k0_dofmap(:,cell),      test_fs6k0%get_cell_dofmap(cell)      )
    end do


    allocate( test_basis ( test_dim_space, test_ndof_cell, nqp_h, nqp_v) )
    call test_fs6k0%compute_basis_function                                     &
       ( test_basis, test_ndof_cell, nqp_h, nqp_v, xp, zp )
    @assertEqual(fs6k0_basis_function, test_basis, epsilon)
    deallocate(test_basis)


    allocate( test_diff_basis( test_dim_space_diff, test_ndof_cell             &
                             , nqp_h, nqp_v) )
    call test_fs6k0%compute_diff_basis_function                                &
       ( test_diff_basis, test_ndof_cell, nqp_h, nqp_v, xp, zp )
    @assertEqual(fs6k0_basis_diff_function, test_diff_basis, epsilon)
    deallocate(test_diff_basis)




    !-------------------------------------------------------------------
    ! Test if the function space returns the correct mesh
    ! Use a subset of the tests from mesh_mod_test.pf
    !-------------------------------------------------------------------
    mesh_out => test_fs0k0%get_mesh()

    !-------------------------------------------------------------------
    ! Test get_face_on_cell()
    iface=3
    lid=9
    test_integer = mesh_out%get_face_on_cell(iface, lid)
    @assertEqual ( 28, test_integer )

    !-------------------------------------------------------------------
    ! Test get_edge_on_cell()
    iedge=1
    lid=5
    test_integer = mesh_out%get_edge_on_cell(iedge, lid)
    @assertEqual ( 27, test_integer )

    iedge=5
    lid=5
    test_integer = mesh_out%get_edge_on_cell(iedge, lid)
    @assertEqual ( 11, test_integer )

    iedge=9
    lid=5
    test_integer = mesh_out%get_edge_on_cell(iedge, lid)
    @assertEqual ( 28, test_integer )

    iedge=12
    lid=5
    test_integer = mesh_out%get_edge_on_cell(iedge, lid)
    @assertEqual ( 36, test_integer )

    iedge=6
    lid=9
    test_integer = mesh_out%get_edge_on_cell(iedge, lid)
    @assertEqual ( 32, test_integer )

    !-------------------------------------------------------------------
    ! Test colouring via function space

    ! Must set colours before use...
    call test_fs0k0%set_colours()

    call test_fs0k0%get_colours(num_colours, num_cell_per_colour, cells_in_colour)

    ! Is there storage for colour map...
    @assertTrue(associated(cells_in_colour), "Colours not set for function space.")

    ! Is total number of colours used meaningful...
    @assertTrue(num_colours > 0, "Non-positive used colour count.")

    ! Did we use all claimed colours...
    total_colours = size(cells_in_colour, 1)
    @assertEqual(total_colours, num_colours, "Reported used colours unequal to actual used total.")

    ! Does the total in each colour match the cells in the colour map...
    do colour_idx=1, num_colours
      nc_colour = num_cell_per_colour(colour_idx)
      cic_colour = count(cells_in_colour(colour_idx,:) /= 0)
      @assertEqual(nc_colour, cic_colour, "Mismatch between num-per-colour total and cell count.")
    end do
    !-------------------------------------------------------------------

    ! Tear down
    call deallocate_reference()
    call purge_function_spaces()
    return
  end subroutine test_func_space 

end module function_space_mod_test
